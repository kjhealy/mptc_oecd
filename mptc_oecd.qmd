---
title: "Health Spending and Life Expectancy in Eighteen OECD Countries"
author:
  - name: "Kieran Healy"
    email: "kieran.healy@duke.edu"
    affiliation: "Duke University"
date: last-modified
bibliography: files/references.bib
citeproc: true
format:
  html: default
  pdf: default
---


## Introduction

I want to produce a version of a figure I first saw in @kenworthy14:_social_democ_americ [p.51]. Versions of it have appeared elsewhere, too. To make it we'll need to get data from the OECD and then write some code to draw the graph. 

```{r}
#| warning: false
#| message: false

library(tidyverse)
my_colors <-  c("grey50", "firebrick")

```

## The Data

We're working in this little project, so our local data files and our output is defined with respect to where the project is on our computer. In R, the `here` package helps us stay disciplined about this. 

```{r}
library(here)
```

We set things up by getting the data from a file in the project.[^dontpanic] It's a comma-separated values or CSV file. To do our work we'll put it in a thing named `df`. 

[^dontpanic]: Don't worry at this point if you don't know any R.

```{r}

## The data are generated by R/make_oecd_df.R
df <- read_csv(
  here("data", "oecd_health_lifexp.csv"),
  col_types = cols(
    country = col_character(),
    iso3 = col_character(),
    year = col_integer(),
    life_exp = col_double(),
    health_ppp = col_double()
  )
)

df
```



There's more data here than we are interested in. We'll look at these countries only:

```{r}
my_countries <- c("AUT", "AUS", "BEL", "CAN", "DEU", "DNK", "ESP", "FIN", "FRA",
             "GBR", "GRC", "IRL", "ITA", "JPN", "NLD", "NOR", "NZL",
             "SWE", "USA")
```

We're also just interested in 1970 and after. And in particular we want to draw a figure that contrasts  the US and all the other countries. For that we'll make an indicator or flag or dummy variable that picks out the US from all the other countries. Finally, we'll smooth the trends a little by calculating a three-year moving average for each country.

```{r}
df_plot <- df |>
  filter(iso3 %in% my_countries, year > 1969) |>
  drop_na() |>
  arrange(country, year) |>
  group_by(country) |>
  mutate(
    us_flag = ifelse(iso3 == "USA", "United States", "Eighteen OECD Countries"),
    avg_spend = slider::slide_dbl(health_ppp, mean, .before = 2, .after = 2)
  )

df_plot  
```

## The Figure and some Tables

Now we write some code to draw the plot we want. The results are shown in @fig-health.


```{r}
#| label: fig-health
#| fig-cap: "The figure we were trying to draw"
#| fig-width: 8
#| fig-height: 8
 
df_plot |>
  ggplot(aes(
    x = avg_spend,
    y = life_exp,
    group = country,
    color = us_flag
  )) +
  geom_line() +
  scale_color_manual(values = my_colors) +
  scale_x_continuous(labels = scales::label_dollar()) +
  labs(
    color = NULL,
    title = "Health Spending and Life Expectancy, 1970-2023",
    x = "Heath Spending (Per capita, constant prices, constant PPPs, five year rolling average)",
    y = "Life Expectancy",
    caption = "Data: OECD. Graph: @kjhealy"
  ) +
  theme_bw() +
  guides(color = guide_legend(nrow = 1)) +
  theme(legend.position = "top", legend.text.position = "top")

```


Let's also make summary table or two while we are here. First, a table of the average life expectancy at birth for every country. This is shown in @tbl-countrymeans.

```{r}
#| label: tbl-countrymeans
#| tbl-cap: "Average Life Expectancy at Birth, in years, 1970-2023"

df_plot |>
  summarize(`Mean` = round(mean(life_exp), 1)) |>
  rename(Country = country) |>
  kableExtra::kable()
```


And second, @tbl-ppp-yrmeans summarizes spending on health each year across countries.

```{r}
#| label: tbl-ppp-yrmeans
#| tbl-cap: "Range of Spending across countries in Constant PPP per capita, selected years 1970-2023, rounded to the nearest dollar."

df_plot |>
  group_by(year) |>
  summarize(across(
    health_ppp,
    list(
      Min = \(x) min(x),
      Mean = \(x) mean(x),
      Median = \(x) median(x),
      Max = \(x) max(x)
    ),
    .names = "{fn}"
  )) |>
  mutate(across(
    starts_with("M"),
    \(x) scales::label_currency(accuracy = 1, prefix = "")(x)
  )) |>
  filter(year %in% c(seq(1970, 2023, 5), 2023)) |>
  rename(Year = year) |>
  kableExtra::kable()

```


## References

::: {#refs}
:::

