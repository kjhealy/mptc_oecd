---
title: "Health Spending and Life Expectancy in Eighteen OECD Countries"
author:
  - name: "Kieran Healy"
    email: "kieran.healy@duke.edu"
    affiliation: "Duke University"
date: last-modified
bibliography: files/references.bib
format:
  html: default
  pdf: default
---


I want to produce a version of a figure I first saw in @kenworthy14:_social_democ_americ [p.51]. Versions of it have appeared elsewhere, too. To make it we'll need to get data from the OECD and then write some code to draw the graph. 

```{r}
#| warning: false
#| message: false

library(tidyverse)
```

```{r}
library(here)

my_colors <-  c("grey50", "firebrick")


## The data are generated by R/make_oecd_df.R
df <- read_csv(here("data", "oecd_health_lifexp.csv"))
```


We'll look at these countries only:

```{r}
compare <- c("AUT", "AUS", "BEL", "CAN", "DEU", "DNK", "ESP", "FIN", "FRA",
             "GBR", "GRC", "IRL", "ITA", "JPN", "NLD", "NOR", "NZL",
             "SWE", "USA")

```

We're just interested in 1970 and after. And we'd like to draw a contrast between the US and the other countries. Finally, we'll smooth the trends a little by calculating a three-year moving average for each country. 

```{r}
df_plot <- df |>
  filter(iso3 %in% compare, year > 1969) |> 
  drop_na() |>
  arrange(country, year) |>
  group_by(country) |> 
  mutate(
    us_flag = ifelse(iso3 == "USA", "United States", "Eighteen OECD Countries"), 
    avg_spend = slider::slide_dbl(health_ppp, mean, 
                                  .before = 1, .after = 1)) 

df_plot  
```

The results are shown in @fig-health.


```{r}
#| label: fig-health
#| fig-cap: "The figure we were trying to draw"
#| fig-width: 8
#| fig-height: 8
 
df_plot |>   
  ggplot(aes(x = avg_spend, y = life_exp, group = country, color = us_flag)) +
  geom_line() +
  scale_color_manual(values = my_colors) +
  scale_x_continuous(labels = scales::label_dollar()) +
  labs(color = NULL,
       title = "Health Spending and Life Expectancy, 1970-2023",
       x = "Heath Spending (Per capita, constant prices, constant PPPs, 3 year rolling average)",
       y = "Life Expectancy",
       caption = "Data: OECD. Graph: @kjhealy") + 
  theme_bw() + 
  guides(color = guide_legend(nrow = 1)) + 
  theme(legend.position = "top", 
        legend.text.position = "top")

```


Let's also make a table while we are here, which we will put in @tbl-countrymeans.

```{r}
#| label: tbl-countrymeans
#| tbl-cap: "Average Life Expectancy at Birth, 1970-2023"

df_plot |> 
  summarize(`Mean` = round(mean(life_exp),1)) |> 
  rename(Country = country) |> 
  kableExtra::kable()
```


And finally, @tbl-ppp-yrmeans summarizes spending on health each year across countries.

```{r}
#| label: tbl-ppp-yrmeans
#| tbl-cap: "Range of Spending across countries in Constant PPP per capita, selected years 1970-2023, rounded to the nearest dollar."

df_plot |> 
  group_by(year) |> 
  summarize(across(health_ppp,           
                   list(
                     Min = \(x) min(x),
                     Mean = \(x) mean(x),
                     Median = \(x) median(x),
                     Max = \(x) max(x)
                     ), 
                   .names = "{fn}"
                   )
           ) |> 
  mutate(across(starts_with("M"), 
                \(x) scales::label_currency(accuracy = 1,
                                            prefix = "")(x))) |> 
  filter(year %in% c(seq(1970, 2023, 5), 2023)) |> 
  rename(Year = year) |> 
  kableExtra::kable()

```



### References

::: {#refs}
:::
